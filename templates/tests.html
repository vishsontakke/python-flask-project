{% extends 'base.html' %}

{% block title %}Tests{% endblock %}

{% block css %}{% endblock %}

{% block content %}

{% include 'breadcrumb.html' %}


{% if current_user.isAdmin %}
    <div class="container">
        <div class="row">
            <div class="card">
                <div class="card-body" style="padding:6px">
                    <button id="add-test" class="btn btn-sm btn-success"><i class="fa-solid fa-plus"></i>&nbsp;Create</button>
                </div>
            </div>
        </div>
    </div>
{% endif %}


<div class="container mt-4">
    <div class="row bg-light p-3 shadow-sm rounded">
        <table id="test-table" class="table">
            <thead>
                <tr class="bg-dark text-light">
                    <th>ID</th>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Marks</th>
                    <th>Time</th>
                    <th>Added on</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% if all_tests %}
                    {% for test in all_tests %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ test.name }}</td>
                            <td>{{ test.subject }}</td>
                            <td>{{ test.marks }}</td>
                            <td>{{ test.time }} min.</td>
                            <td>{{ test.created_at.strftime('%d %B, %Y') }}</td>
                            <td>
                                <button test-id="{{ test.id }}" class="test-edit btn btn-sm btn-outline-info"><i class="fa-regular fa-pen-to-square"></i></button>
                                <button test-id="{{ test.id }}" class="test-delete btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash-can"></i></button>
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>



<!-- create form -->
<div class="modal fade" id="add-test-modal" hold-values="0" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="add-testLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="test-form">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="add-testLabel"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="mb-3">
                        {{ testForm.name.label }}
                        {{ testForm.name }}
                    </div>
                    <div class="row">
                        <div class="col mb-3">
                            {{ testForm.subject.label }}
                            {{ testForm.subject }}
                        </div>
                        <div class="col mb-3">
                            {{ testForm.time.label }}
                            {{ testForm.time }}
                        </div>
                        <div class="col mb-3">
                            {{ testForm.marks.label }}
                            {{ testForm.marks }}
                            <span class="marks-help-text" style="display:none;"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col mb-3">
                            <div class="col mb-3">
                                Question Selected : <span id="selected-question-count" class="fs-3">0</span>
                            </div>
                        </div>
                        <div class="col mb-3">
                            {{ testForm.questions }}
                            
                            <button class="btn btn-outline-dark" type="button" id="question-selection-btn">
                                Select Questions &nbsp;&nbsp;
                                <i class="fa-solid fa-list"></i>
                            </button>

                        </div>
                    </div>
                    
            
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="test-form-submit" action="add" class="btn btn-success">Generate Test</button>
                </div>
            </div>
        </form>
    </div>
</div>


<div class="modal modal-xl fade vh-80" id="question-selection-panel" data-bs-backdrop="static"  aria-hidden="true" aria-labelledby="question-selection-panel-Label" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-5" id="question-selection-panel-Label">Select Questions</h1>
            <span class="vr ms-2"></span>
            <button class="ms-2 btn btn-sm btn-outline-secondary" id="question-selection-reset">
                <i class="fa-solid fa-arrow-rotate-right"></i>
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body overflow-auto" style="background:#f1f1f1;max-height:70vh;">
            <div class="container">
                <div class="row col-md-4">
                    <select class="form-select mb-3" id="subject-filter" aria-label="Subject Filter">
                        <option value="">All Subject</option>
                        {% for subject in all_subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <form id="question-selection-form">
                <div class="container">
                    <div class="row">
                        {% if questionList %}
                        <div class="container">
                            <div class="row">
                                {% for k, v in questionList.items() %}
                                    <div class="card mb-2" id="subject-{{ k }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ v.subject_name }}</h5>
                                            <hr>
                                            <div class="row">
                                                {% if v.list %}
                                                    {% for level, questions in v.list.items() %}
    
                                                        {% if questionLevels[level|int] == 'beginner' %}
                                                            {% set sectionClass = 'text-success' %}
                                                        {% elif questionLevels[level|int] == 'intermediate' %}
                                                            {% set sectionClass = 'text-warning' %}
                                                        {% elif questionLevels[level|int] == 'advance' %}
                                                            {% set sectionClass = 'text-danger' %}
                                                        {% endif %}
    
                                                        <h5 class="{{ sectionClass }}">{{ questionLevels[level|int]|title }}</h5>
                                                        
                                                        {% if questions %}
                                                            {% for question in questions %}
                                                                <div class="col-md-6 mb-1">
                                                                    <!-- <button class="btn btn-outline-secondary" style="padding-bottom:0;">{{ question.question|safe }}</button> -->
                                                                    <input type="checkbox" class="btn-check selection-inputs" id="{{ v.subject_name }}-{{ question.id }}" value="{{ question.id }}" marks="{{ question.marks }}" autocomplete="off">
                                                                    <label class="btn btn-outline-secondary" for="{{ v.subject_name }}-{{ question.id }}" style="margin-bottom:0;text-align:left;">
                                                                        <span class="badge" style="background-color:#a7a7a7;">
                                                                            marks : <span class="question-marks">{{ question.marks }}</span>
                                                                        </span>
                                                                        {{ question.question|safe }}
                                                                    </label>
                                                                </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
          <button id="submit-selection" class="btn btn-primary">Add Selection</button>
        </div>
      </div>
    </div>
</div>


{% endblock %}


{% block script %}
    <script src="{{ url_for('static', filename='js/tests.js') }}" ></script>
{% endblock %}